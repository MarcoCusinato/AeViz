#!/usr/bin/env python
"""
This script is used to infer the maximum detection distance for
neutrino and GW signals. The wqay it works it is very simplistic,
therefore I invite people to look at proper pipelines for a proper
detection rate. Said this, the simplistic way I use is to find the
distance at which the SNR (for GWs) or the event detection number
(for neutrinos) falls below a certain threshold.
"""

from AeViz.simulation import Simulation
from AeViz.units import u
import numpy as np
import argparse
parser = argparse.ArgumentParser()
parser.add_argument('--sim-name', type=str, required=True,
                    help="Name of the simulation of which postprocessing ' \
                        'will be done.")
parser.add_argument('--sim-path', type=str, default=None, required=False,
                    help="Path of the simulation.")
parser.add_argument('--channel', type=str, required=True,
                    help="Multimessenger channel to look at: possible values " \
                        "[GWs, neutrinos]")
parser.add_argument('--los', type=str, default='eq',
                    help="The line of sight to compute the equivalent" \
                    "neutrino emission of: possible values ['all'," \
                    "eq, pol, avg]. For the GWs avg is not available.")
parser.add_argument('--threshold', type=float, default=15,
                    help="SNR or detection rate threshold.")
parser.add_argument('--detector', type=str, required=True,
                    help="The name of the neutrino or GW wave detector to use.")
parser.add_argument('--transformation', type=str, default='NoTransformation',
                    help="The flavour transformation to use in the neutrino " \
                    "detection.")
parser.add_argument('--time-range', type=float, nargs='+', default=[None, None],
                    help="The part of the signal to consider.")
args = parser.parse_args()

## Load the simultion data
sim = Simulation(args.sim_name, args.sim_path)

ref_distance = 10 * u.kpc

if args.channel == 'neutrinos':
    from AeViz.utils.snewpy.detection_rates import total_events_number
    tot_ev, det = total_events_number(sim,
                                      args.los,
                                      ref_distance,
                                      [args.time_range[0], args.time_range[1]],
                                      args.transformation,
                                      args.detector
                                      )
    max_distance = ref_distance * np.sqrt(tot_ev / args.threshold)
    det_name = det.name
elif args.channel == "GWs":
    if args.los == 'avg':
        raise TypeError('avg los not available for GWs.')
    from AeViz.utils.physics.GW_utils import compute_SNR
    if args.time_range[0] is None and args.time_range[1] is None:
        args.time_range = None 
    snr, det_name = compute_SNR(sim,
                                args.detector,
                                'h'+args.los,
                                distance=ref_distance,
                                time_range=args.time_range)
    max_distance = ref_distance * snr / args.threshold
else:
    raise TypeError("Channel not recognized.")


print(f'--------------------------------------------')
print(f'Model: {sim.simulation_name}')
print(f'Channel: {args.channel}')
print(f'Threshold: {args.threshold}')
print(f'Detector: {det_name}')
if args.channel == 'neutrinos':
    print(f'Transormation: {args.transformation}')
print(f'Maximum detection distance: {max_distance.to(u.kpc).value:.3f} [kpc]')
print(f'--------------------------------------------')